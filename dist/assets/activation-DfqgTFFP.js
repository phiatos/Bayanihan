import"./global-Dd8t204S.js";/* empty css                */const J={apiKey:"AIzaSyDJxMv8GCaMvQT2QBW3CdzA3dV5X_T2KqQ",authDomain:"bayanihan-5ce7e.firebaseapp.com",databaseURL:"https://bayanihan-5ce7e-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"bayanihan-5ce7e",storageBucket:"bayanihan-5ce7e.appspot.com",messagingSenderId:"593123849917",appId:"1:593123849917:web:eb85a63a536eeff78ce9d4",measurementId:"G-ZTQ9VXXVV0"};firebase.initializeApp(J);const w=firebase.database();let b=[],I=[];const V=["Select Calamity","Typhoon","Earthquake","Flood","Volcanic Eruption","Landslide","Tsunami"];let d=1;const T=5,x=document.querySelector("#orgTable tbody"),P=document.querySelector("#searchInput"),h=document.querySelector("#sortSelect"),ee=document.querySelector("#entriesInfo"),M=document.querySelector("#pagination"),R=document.querySelector(".clear-btn"),te=document.getElementById("addActivationBtn"),O=document.getElementById("activationModal"),oe=document.getElementById("closeActivationModal"),Y=document.getElementById("modalTitle"),D=document.getElementById("endorseModal"),ne=document.getElementById("closeEndorseModal"),q=document.getElementById("mapModal"),ae=document.getElementById("closeMapModal"),ie=document.getElementById("cancelMapModalBtn"),re=document.getElementById("saveLocationBtn"),le=document.getElementById("mapSearchInput"),z=document.getElementById("modalStep1"),A=document.getElementById("selectGroupDropdown"),N=document.getElementById("modalNextStepBtn"),G=document.getElementById("modalStep2"),K=document.getElementById("selectedOrgName"),m=document.getElementById("modalAreaInput"),g=document.getElementById("modalLatitudeInput"),f=document.getElementById("modalLongitudeInput"),B=document.getElementById("modalCalamitySelect"),v=document.getElementById("modalTyphoonNameInput"),ce=document.getElementById("modalActivateSubmitBtn"),se=document.getElementById("modalPrevStepBtn"),de=document.getElementById("pinLocationBtn");let s=null,i,y=[],C,S;function ue(){const e={lat:14.5995,lng:120.9842};i=new google.maps.Map(document.getElementById("mapContainer"),{center:e,zoom:10,mapTypeId:"roadmap"}),S=new google.maps.Geocoder,C=new google.maps.places.Autocomplete(le,{componentRestrictions:{country:"PH"}}),C.bindTo("bounds",i),C.addListener("place_changed",()=>{const o=C.getPlace();if(!o.geometry||!o.geometry.location){Swal.fire({icon:"error",title:"Location Not Found",text:"Please select a valid location from the dropdown."});return}i.setCenter(o.geometry.location),i.setZoom(16),L();const n=new google.maps.Marker({position:o.geometry.location,map:i,title:o.name});y.push(n);const a=new google.maps.InfoWindow({content:`<strong>${o.name}</strong><br>${o.formatted_address}`});n.addListener("click",()=>{a.open(i,n)}),a.open(i,n),m.value=o.formatted_address,g.value=o.geometry.location.lat(),f.value=o.geometry.location.lng()}),i.addListener("click",o=>{L();const n=new google.maps.Marker({position:o.latLng,map:i,title:"Pinned Location"});y.push(n),S.geocode({location:o.latLng},(a,l)=>{let r=`Pinned Location<br>Lat: ${o.latLng.lat()}, Lng: ${o.latLng.lng()}`;l==="OK"&&a[0]?(r=`Pinned Location<br>${a[0].formatted_address}`,m.value=a[0].formatted_address):m.value=`Lat: ${o.latLng.lat()}, Lng: ${o.latLng.lng()}`,g.value=o.latLng.lat(),f.value=o.latLng.lng();const c=new google.maps.InfoWindow({content:r});n.addListener("click",()=>{c.open(i,n)}),c.open(i,n)}),i.setCenter(o.latLng),i.setZoom(16)});const t=document.createElement("button");t.textContent="My Location",t.style.cssText=`
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin: 10px;
    `,t.addEventListener("click",me),i.controls[google.maps.ControlPosition.TOP_RIGHT].push(t),navigator.geolocation&&navigator.geolocation.getCurrentPosition(o=>{const n={lat:o.coords.latitude,lng:o.coords.longitude};i.setCenter(n),i.setZoom(16),L();const a=new google.maps.Marker({position:n,map:i,title:"You are here",icon:{url:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png"}});y.push(a),S.geocode({location:n},(l,r)=>{let c="You are here";r==="OK"&&l[0]&&(c=`You are here<br>${l[0].formatted_address}`,m.value=l[0].formatted_address,g.value=n.lat,f.value=n.lng);const u=new google.maps.InfoWindow({content:c});a.addListener("click",()=>u.open(i,a)),u.open(i,a)})},o=>{console.error("Geolocation error:",o),Swal.fire({icon:"error",title:"Location Error",text:Z(o)})},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}function L(){y.forEach(e=>e.setMap(null)),y=[]}function me(){navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{const t={lat:e.coords.latitude,lng:e.coords.longitude};i.setCenter(t),i.setZoom(16),L();const o=new google.maps.Marker({position:t,map:i,title:"You are here",icon:{url:"http://maps.google.com/mapfiles/ms/icons/blue-dot.png"}});y.push(o),S.geocode({location:t},(n,a)=>{let l="You are here";a==="OK"&&n[0]&&(l=`You are here<br>${n[0].formatted_address}`,m.value=n[0].formatted_address,g.value=t.lat,f.value=t.lng);const r=new google.maps.InfoWindow({content:l});o.addListener("click",()=>r.open(i,o)),r.open(i,o)})},e=>{console.error("Geolocation error:",e),Swal.fire({icon:"error",title:"Location Error",text:Z(e)})},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}function Z(e){switch(e.code){case e.PERMISSION_DENIED:return"Location access denied. Please allow location access in your browser settings.";case e.POSITION_UNAVAILABLE:return"Location information is unavailable. Ensure your device has a working GPS or network connection.";case e.TIMEOUT:return"Location request timed out. Please try again.";default:return"Unable to retrieve your location."}}firebase.auth().onAuthStateChanged(e=>{e?(console.log("User is authenticated:",e.uid),pe()):(console.log("No user is authenticated. Attempting anonymous sign-in..."),firebase.auth().signInAnonymously().then(()=>console.log("Signed in anonymously")).catch(t=>{console.error("Anonymous auth failed:",t.code,t.message),Swal.fire({icon:"error",title:"Authentication Error",text:`Failed to authenticate: ${t.message}. Please check your network and Firebase configuration.`})}))});function pe(){console.log("Setting up real-time listener for volunteerGroups..."),w.ref("volunteerGroups").on("value",e=>{const t=e.val();if(console.log("Volunteer groups data received:",t),b=[],t){for(let o in t)b.push({no:parseInt(o),organization:t[o].organization||"Unknown",hq:t[o].hq||"Not specified",contactPerson:t[o].contactPerson||"Unknown",email:t[o].email||"Not specified",mobileNumber:t[o].mobileNumber||"Not specified"});b.sort((o,n)=>o.no-n.no)}F()},e=>{console.error("Error listening for volunteerGroups:",e.code,e.message),Swal.fire({icon:"error",title:"Error",text:`Failed to load volunteer groups: ${e.message}`})}),console.log("Setting up real-time listener for activations..."),w.ref("activations").orderByChild("activationDate").on("value",e=>{const t=e.val();if(console.log("Activations data received:",t),I=[],t){for(let o in t){const n=t[o];if(n.status==="active"){const a=b.find(l=>l.no===n.groupId);I.push({id:o,no:n.no||0,groupId:n.groupId,organization:n.organization||"Unknown",hq:n.hq||"Not specified",areaOfOperation:n.areaOfOperation||"Not specified",calamity:n.calamityType||"Typhoon",typhoonName:n.typhoonName||"",status:n.status,activationDate:n.activationDate,contactPerson:a?a.contactPerson:"N/A",email:a?a.email:"N/A",mobileNumber:a?a.mobileNumber:"N/A",latitude:n.latitude||null,longitude:n.longitude||null})}}I.sort((o,n)=>{const a=new Date(o.activationDate);return new Date(n.activationDate)-a})}E()},e=>{console.error("Error listening for activations:",e.code,e.message),Swal.fire({icon:"error",title:"Error",text:`Failed to load activations: ${e.message}`})})}function F(){A.innerHTML='<option value="">-- Select an Organization --</option>',b.forEach(e=>{const t=document.createElement("option");t.value=e.no,t.textContent=`${e.organization} (${e.hq})`,A.appendChild(t)})}function E(e=I){x.innerHTML="";const t=(d-1)*T,o=t+T,n=e.slice(t,o);if(n.length===0&&e.length>0&&d>1){d--,E(e);return}else if(n.length===0&&e.length===0){const a=document.createElement("tr");a.innerHTML='<td colspan="10" style="text-align: center;">No active group activations to display.</td>',x.appendChild(a)}n.forEach((a,l)=>{const r=t+l+1,c=document.createElement("tr");let u=a.calamity;a.calamity==="Typhoon"&&a.typhoonName&&(u+=` (${a.typhoonName})`),c.innerHTML=`
            <td>${r}</td>
            <td>${a.organization}</td>
            <td>${a.hq}</td>
            <td>${a.areaOfOperation||"N/A"}</td>
            <td>${a.contactPerson||"N/A"}</td>
            <td>${a.email||"N/A"}</td>
            <td>${a.mobileNumber||"N/A"}</td>
            <td>${u||"N/A"}</td>
            <td><span class="status-circle ${a.status==="active"?"green":"red"}"></span> ${a.status}</td>
            <td>
                <button class="action-button-endorse-button" data-activation-id="${a.id}" data-group-id="${a.groupId}">Send Relief Assistance</button>
                <button class="action-button" data-activation-id="${a.id}" data-group-id="${a.groupId}">Deactivate</button>
            </td>
        `,x.appendChild(c)}),ee.textContent=`Showing ${t+1} to ${Math.min(o,e.length)} of ${e.length} entries`,Le(e.length)}function ge(){const e=P.value.trim().toLowerCase();R.style.display=e?"flex":"none",d=1,E(_())}R.style.display="none";P.addEventListener("input",ge);function fe(){Y.textContent="Add New Activation",z.classList.add("active"),G.classList.remove("active"),A.value="",N.disabled=!0,s=null,j(),F(),O.style.display="flex"}function j(){K.textContent="",m.value="",g.value="",f.value="",B.innerHTML=V.map((e,t)=>t===0?'<option value="" disabled selected>-- Select Calamity Type --</option>':`<option value="${e}">${e}</option>`).join(""),v.style.display="none",v.value=""}function Q(){Y.textContent="Add New Activation",z.classList.add("active"),G.classList.remove("active"),s=null,N.disabled=!0,A.value="",j(),F()}function ve(){if(!s){Swal.fire({icon:"warning",title:"No Group Selected",text:"Please select an organization before proceeding."});return}z.classList.remove("active"),G.classList.add("active"),K.textContent=s.organization,B.innerHTML=V.map((e,t)=>t===0?'<option value="" disabled selected>-- Select Calamity Type --</option>':`<option value="${e}">${e}</option>`).join(""),v.style.display="none",v.value="",m.value="",g.value="",f.value=""}function U(){O.style.display="none",s=null,Q()}function ye(){q.style.display="flex",setTimeout(()=>{if(!i)ue();else{google.maps.event.trigger(i,"resize");const e=m.value;e?S.geocode({address:e},(t,o)=>{if(o==="OK"&&t[0]){i.setCenter(t[0].geometry.location),L();const n=new google.maps.Marker({map:i,position:t[0].geometry.location,title:e});y.push(n)}}):(i.setCenter({lat:14.5995,lng:120.9842}),i.setZoom(10))}},100)}function $(){q.style.display="none",L()}te.addEventListener("click",fe);oe.addEventListener("click",U);ae.addEventListener("click",$);ie.addEventListener("click",$);window.addEventListener("click",e=>{e.target===O?U():e.target===q?$():e.target===D&&W()});A.addEventListener("change",e=>{const t=parseInt(e.target.value);s=b.find(o=>o.no===t)||null,N.disabled=!s});N.addEventListener("click",ve);se.addEventListener("click",Q);B.addEventListener("change",()=>{B.value==="Typhoon"?v.style.display="inline-block":(v.style.display="none",v.value="")});de.addEventListener("click",ye);re.addEventListener("click",()=>{if(!m.value||!g.value||!f.value){Swal.fire({icon:"warning",title:"No Location Selected",text:"Please select a location by searching or clicking on the map."});return}$()});async function he(){try{const t=(await w.ref("activations").once("value")).val();let o=0;return t&&Object.values(t).forEach(n=>{n.no&&n.no>o&&(o=n.no)}),o+1}catch(e){throw console.error("Error fetching max activation number:",e),e}}ce.addEventListener("click",async()=>{if(!s){Swal.fire({icon:"error",title:"Error",text:"No organization selected for activation."});return}const e=m.value.trim(),t=B.value,o=t==="Typhoon"?v.value.trim():"",n=g.value,a=f.value;if(!e){Swal.fire({icon:"warning",title:"Missing Field",text:"Please enter an Area of Operations."});return}if(!t||t==="Select Calamity"){Swal.fire({icon:"warning",title:"Missing Field",text:"Please select a Calamity Type."});return}if(t==="Typhoon"&&!o){Swal.fire({icon:"warning",title:"Missing Field",text:"Please enter the Typhoon Name."});return}if(!n||!a){Swal.fire({icon:"warning",title:"Missing Location",text:"Please pin a location on the map."});return}if(!firebase.auth().currentUser){Swal.fire({icon:"error",title:"Authentication Error",text:"User not authenticated. Please refresh the page and try again."});return}const r=w.ref("activations").orderByChild("groupId").equalTo(s.no);try{const c=await r.once("value");let u=!1;if(c.forEach(X=>{const k=X.val();if(k.status==="active"&&k.areaOfOperation.toLowerCase()===e.toLowerCase()&&k.calamityType.toLowerCase()===t.toLowerCase())return u=!0,!0}),u){Swal.fire({icon:"warning",title:"Activation Conflict",text:`${s.organization} is already active for "${t}" in "${e}". Please deactivate the existing operation first or choose a different area or calamity.`});return}const p={no:await he(),groupId:s.no,organization:s.organization,hq:s.hq,areaOfOperation:e,calamityType:t,typhoonName:o,status:"active",activationDate:new Date().toISOString(),latitude:parseFloat(n),longitude:parseFloat(a)};console.log("Adding new activation record:",p),await w.ref("activations").push(p),Swal.fire({icon:"success",title:"Activated!",text:`${s.organization} has been activated for ${t} in ${e}.`}),U(),d=1,E()}catch(c){console.error("Error adding activation:",c),Swal.fire({icon:"error",title:"Error",text:`Failed to activate group: ${c.message}`})}});function be(){D.style.display="flex"}function W(){D.style.display="none"}ne.addEventListener("click",W);x.addEventListener("click",e=>{const t=e.target,o=t.getAttribute("data-activation-id"),n=t.getAttribute("data-group-id");t.classList.contains("action-button-endorse-button")?(console.log(`Endorse button clicked for activation ID: ${o}, Group ID: ${n}`),be()):t.classList.contains("action-button")&&Swal.fire({title:"Are you sure?",text:`Do you want to deactivate this specific operation for group ID ${n}?`,icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes"}).then(a=>{if(a.isConfirmed){if(!firebase.auth().currentUser){Swal.fire({icon:"error",title:"Authentication Error",text:"User not authenticated."});return}const r={status:"inactive",deactivationDate:new Date().toISOString()};w.ref(`activations/${o}`).update(r).then(()=>{Swal.fire("Deactivated!","The activation has been marked inactive.","success")}).catch(c=>{console.error("Error deactivating activation:",c),Swal.fire({icon:"error",title:"Error",text:`Failed to deactivate: ${c.message}`})})}})});function Le(e){M.innerHTML="";const t=Math.ceil(e/T),o=5,n=(r,c=null,u=!1,H=!1)=>{const p=document.createElement("button");return p.textContent=r,u&&(p.disabled=!0),H&&p.classList.add("active-page"),c!==null&&p.addEventListener("click",()=>{d=c,E(_())}),p};if(t===0)return;M.appendChild(n("Prev",d-1,d===1));let a=Math.max(1,d-Math.floor(o/2)),l=Math.min(t,a+o-1);l-a<o-1&&(a=Math.max(1,l-o+1));for(let r=a;r<=l;r++)M.appendChild(n(r,r,!1,r===d));M.appendChild(n("Next",d+1,d===t))}function _(){let e=I.filter(t=>{const o=P.value.trim().toLowerCase();return Object.values(t).some(n=>typeof n=="string"||typeof n=="number"?n.toString().toLowerCase().includes(o):!1)});return h.value?e.sort((t,o)=>{if(h.value==="organization")return t.organization.localeCompare(o.organization);if(h.value==="hq")return t.hq.localeCompare(o.hq);if(h.value==="status"){const n={active:1,inactive:2};return n[t.status]-n[o.status]}else if(h.value==="calamity")return t.calamity.localeCompare(o.calamity);return 0}):e.sort((t,o)=>{const n=new Date(t.activationDate);return new Date(o.activationDate)-n}),e}h.addEventListener("change",()=>{d=1,E(_())});
